FROM debian:12-slim AS build
RUN apt-get update && apt-get install -y --no-install-recommends build-essential g++ qtbase5-dev qtbase5-dev-tools qt5-qmake ca-certificates && rm -rf /var/lib/apt/lists/*
WORKDIR /src
COPY . /src

# Если в server/ есть .pro — используем qmake; если нет — создаём простое .pro автоматически
RUN if [ -f server.pro ] || [ -f server/*.pro ]; then \
      qmake -project -o project.pro || true; \
      mv project.pro project_auto.pro || true; \
      qmake project_auto.pro || qmake || true; \
      make -j$(nproc) || true; \
    else \
      # fallback: compile all .cpp and link Qt libs (core, network, widgets if needed)
      CPP_FILES="$(find . -name '*.cpp' | tr '\n' ' ')"; \
      g++ -std=c++11 -O2 -pthread -o /srv_server $CPP_FILES `pkg-config --cflags --libs Qt5Core Qt5Network Qt5Widgets 2>/dev/null` || true; \
    fi

# Try to locate produced binary (common names)
RUN if [ -f ./server ] ; then cp ./server /srv_server; fi || true
RUN if [ -f ./srv_server ] ; then true; fi || true

FROM debian:12-slim
RUN apt-get update && apt-get install -y --no-install-recommends libqt5core5a libqt5network5 libstdc++6 ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=build /srv_server /usr/local/bin/server
EXPOSE 12345
ENTRYPOINT ["/usr/local/bin/server"]
